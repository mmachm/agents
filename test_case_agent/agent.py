from google.adk.agents import Agent
from google.adk.agents.callback_context import CallbackContext
from google.adk.models import LlmRequest, LlmResponse
from google.genai.types import Part

from config import ROOT_AGENT_MODEL

from .instructions import instructions


# --- Define the Callback Function ---
def table_adder(callback_context: CallbackContext, llm_request: LlmRequest) -> LlmResponse | None:
    """Inspects/modifies the LLM request or skips the call."""
    agent_name = callback_context.agent_name
    #example_table = Part(text='[{"name": "Alice", "age": 30, "skill": 42}, {"name": "Bob", "age": 25, "skill": 55}, {"name": "Charlie", "age": 35, "skill": 20}]')  # Example table
    example_table = Part(text='[{"match_id":1842637.0,"date_planned_start":1749804000.0,"match_start":1749804001.0,"home_player":"Donovan","away_player":"Luka","home_team":"Dallas Mavericks","away_team":"Denver Nuggets","player_pair":"Donovan_Luka","mw_prob_home":0.1767,"mw_prob_away":0.8233,"mw_prob_draw":null,"inp_total_points":114.1,"tp_threshold":114.5,"tp_prob_over":0.4922,"tp_prob_under":0.5078,"FT_home_points":51.0,"FT_away_points":60.0,"FT_total_points":111.0,"q1_home_points":11.0,"q2_home_points":14.0,"q3_home_points":13.0,"q4_home_points":13.0,"q1_away_points":17.0,"q2_away_points":13.0,"q3_away_points":18.0,"q4_away_points":12.0},{"match_id":1842638.0,"date_planned_start":1749805920.0,"match_start":1749805931.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Brooklyn Nets","away_team":"Golden State Warriors","player_pair":"Donovan_IceKimi","mw_prob_home":0.951,"mw_prob_away":0.049,"mw_prob_draw":null,"inp_total_points":113.11,"tp_threshold":113.5,"tp_prob_over":0.4861,"tp_prob_under":0.5139,"FT_home_points":65.0,"FT_away_points":61.0,"FT_total_points":126.0,"q1_home_points":16.0,"q2_home_points":16.0,"q3_home_points":15.0,"q4_home_points":18.0,"q1_away_points":9.0,"q2_away_points":20.0,"q3_away_points":19.0,"q4_away_points":13.0},{"match_id":1842639.0,"date_planned_start":1749807840.0,"match_start":1749807839.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Brooklyn Nets","away_team":"Golden State Warriors","player_pair":"IceKimi_Luka","mw_prob_home":0.8422,"mw_prob_away":0.1578,"mw_prob_draw":null,"inp_total_points":131.94,"tp_threshold":131.5,"tp_prob_over":0.5074,"tp_prob_under":0.4925,"FT_home_points":77.0,"FT_away_points":69.0,"FT_total_points":146.0,"q1_home_points":20.0,"q2_home_points":22.0,"q3_home_points":19.0,"q4_home_points":16.0,"q1_away_points":13.0,"q2_away_points":21.0,"q3_away_points":19.0,"q4_away_points":16.0},{"match_id":1842640.0,"date_planned_start":1749809760.0,"match_start":1749809761.0,"home_player":"Donovan","away_player":"Luka","home_team":"Boston Celtics","away_team":"Philadelphia 76ers","player_pair":"Donovan_Luka","mw_prob_home":0.166,"mw_prob_away":0.834,"mw_prob_draw":null,"inp_total_points":113.8,"tp_threshold":113.5,"tp_prob_over":0.5043,"tp_prob_under":0.4957,"FT_home_points":53.0,"FT_away_points":62.0,"FT_total_points":115.0,"q1_home_points":16.0,"q2_home_points":15.0,"q3_home_points":15.0,"q4_home_points":7.0,"q1_away_points":16.0,"q2_away_points":12.0,"q3_away_points":15.0,"q4_away_points":19.0},{"match_id":1842641.0,"date_planned_start":1749811680.0,"match_start":1749811680.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Boston Celtics","away_team":"Philadelphia 76ers","player_pair":"Donovan_IceKimi","mw_prob_home":0.9517,"mw_prob_away":0.0483,"mw_prob_draw":null,"inp_total_points":115.5,"tp_threshold":115.5,"tp_prob_over":0.4938,"tp_prob_under":0.5062,"FT_home_points":59.0,"FT_away_points":49.0,"FT_total_points":108.0,"q1_home_points":17.0,"q2_home_points":16.0,"q3_home_points":10.0,"q4_home_points":16.0,"q1_away_points":14.0,"q2_away_points":10.0,"q3_away_points":14.0,"q4_away_points":11.0},{"match_id":1842642.0,"date_planned_start":1749813600.0,"match_start":1749813605.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Toronto Raptors","away_team":"Washington Wizards","player_pair":"IceKimi_Luka","mw_prob_home":0.8422,"mw_prob_away":0.1578,"mw_prob_draw":null,"inp_total_points":133.13,"tp_threshold":133.5,"tp_prob_over":0.4914,"tp_prob_under":0.5086,"FT_home_points":64.0,"FT_away_points":61.0,"FT_total_points":125.0,"q1_home_points":12.0,"q2_home_points":20.0,"q3_home_points":18.0,"q4_home_points":14.0,"q1_away_points":16.0,"q2_away_points":11.0,"q3_away_points":18.0,"q4_away_points":16.0},{"match_id":1842643.0,"date_planned_start":1749815520.0,"match_start":1749815526.0,"home_player":"Donovan","away_player":"Luka","home_team":"Toronto Raptors","away_team":"Washington Wizards","player_pair":"Donovan_Luka","mw_prob_home":0.1629,"mw_prob_away":0.8371,"mw_prob_draw":null,"inp_total_points":113.8,"tp_threshold":113.5,"tp_prob_over":0.5043,"tp_prob_under":0.4957,"FT_home_points":65.0,"FT_away_points":71.0,"FT_total_points":136.0,"q1_home_points":10.0,"q2_home_points":25.0,"q3_home_points":16.0,"q4_home_points":14.0,"q1_away_points":21.0,"q2_away_points":14.0,"q3_away_points":21.0,"q4_away_points":15.0},{"match_id":1842644.0,"date_planned_start":1749819360.0,"match_start":1749819363.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Los Angeles Lakers","away_team":"New York Knicks","player_pair":"Donovan_IceKimi","mw_prob_home":0.952,"mw_prob_away":0.048,"mw_prob_draw":null,"inp_total_points":113.0,"tp_threshold":113.5,"tp_prob_over":0.4822,"tp_prob_under":0.5178,"FT_home_points":71.0,"FT_away_points":48.0,"FT_total_points":119.0,"q1_home_points":18.0,"q2_home_points":18.0,"q3_home_points":22.0,"q4_home_points":13.0,"q1_away_points":18.0,"q2_away_points":10.0,"q3_away_points":9.0,"q4_away_points":11.0},{"match_id":1842645.0,"date_planned_start":1749821280.0,"match_start":1749821281.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Los Angeles Lakers","away_team":"New York Knicks","player_pair":"IceKimi_Luka","mw_prob_home":0.8448,"mw_prob_away":0.1552,"mw_prob_draw":null,"inp_total_points":131.94,"tp_threshold":131.5,"tp_prob_over":0.5118,"tp_prob_under":0.4882,"FT_home_points":61.0,"FT_away_points":64.0,"FT_total_points":125.0,"q1_home_points":18.0,"q2_home_points":16.0,"q3_home_points":16.0,"q4_home_points":11.0,"q1_away_points":16.0,"q2_away_points":18.0,"q3_away_points":17.0,"q4_away_points":13.0},{"match_id":1842646.0,"date_planned_start":1749823200.0,"match_start":1749823207.0,"home_player":"Donovan","away_player":"Luka","home_team":"Atlanta Hawks","away_team":"Detroit Pistons","player_pair":"Donovan_Luka","mw_prob_home":0.1614,"mw_prob_away":0.8386,"mw_prob_draw":null,"inp_total_points":115.9,"tp_threshold":115.5,"tp_prob_over":0.5103,"tp_prob_under":0.4897,"FT_home_points":55.0,"FT_away_points":73.0,"FT_total_points":128.0,"q1_home_points":12.0,"q2_home_points":17.0,"q3_home_points":14.0,"q4_home_points":12.0,"q1_away_points":23.0,"q2_away_points":17.0,"q3_away_points":18.0,"q4_away_points":15.0}]')
    if llm_request.contents[-1].parts[0].text is not None:
        llm_request.contents[-1].parts.append(example_table)
        print(f"[Callback] Added data table for agent: {agent_name}")
    return None


root_agent = Agent(
    name="test_case_generation_agent",
    model=ROOT_AGENT_MODEL,
    description=(
        "Agent that processes data from a given table into a new column based on a query given in natural language."
    ),
    instruction=instructions,
    before_model_callback=table_adder,
)
