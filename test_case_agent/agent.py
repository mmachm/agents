from google.adk.agents import Agent
from google.adk.agents.callback_context import CallbackContext
from google.adk.models import LlmRequest, LlmResponse
from google.genai.types import Part

from config import ROOT_AGENT_MODEL

from .instructions import instructions


# --- Define the Callback Function ---
def table_adder(callback_context: CallbackContext, llm_request: LlmRequest) -> LlmResponse | None:
    """Inspects/modifies the LLM request or skips the call."""
    agent_name = callback_context.agent_name
    #example_table = Part(text='[{"name": "Alice", "age": 30, "skill": 42}, {"name": "Bob", "age": 25, "skill": 55}, {"name": "Charlie", "age": 35, "skill": 20}]')  # Example table
    example_table = Part(text='[{"match_id":1842639.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Brooklyn Nets","away_team":"Golden State Warriors","player_pair":"IceKimi_Luka","mw_prob_home":0.8422,"mw_prob_away":0.1578,"inp_total_points":131.94,"tp_threshold":131.5,"tp_prob_over":0.5074,"tp_prob_under":0.4925,"FT_home_points":77.0,"FT_away_points":69.0,"FT_total_points":146.0},{"match_id":1842640.0,"home_player":"Donovan","away_player":"Luka","home_team":"Boston Celtics","away_team":"Philadelphia 76ers","player_pair":"Donovan_Luka","mw_prob_home":0.166,"mw_prob_away":0.834,"inp_total_points":113.8,"tp_threshold":113.5,"tp_prob_over":0.5043,"tp_prob_under":0.4957,"FT_home_points":53.0,"FT_away_points":62.0,"FT_total_points":115.0},{"match_id":1842641.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Boston Celtics","away_team":"Philadelphia 76ers","player_pair":"Donovan_IceKimi","mw_prob_home":0.9517,"mw_prob_away":0.0483,"inp_total_points":115.5,"tp_threshold":115.5,"tp_prob_over":0.4938,"tp_prob_under":0.5062,"FT_home_points":59.0,"FT_away_points":49.0,"FT_total_points":108.0},{"match_id":1842642.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Toronto Raptors","away_team":"Washington Wizards","player_pair":"IceKimi_Luka","mw_prob_home":0.8422,"mw_prob_away":0.1578,"inp_total_points":133.13,"tp_threshold":133.5,"tp_prob_over":0.4914,"tp_prob_under":0.5086,"FT_home_points":64.0,"FT_away_points":61.0,"FT_total_points":125.0},{"match_id":1842643.0,"home_player":"Donovan","away_player":"Luka","home_team":"Toronto Raptors","away_team":"Washington Wizards","player_pair":"Donovan_Luka","mw_prob_home":0.1629,"mw_prob_away":0.8371,"inp_total_points":113.8,"tp_threshold":113.5,"tp_prob_over":0.5043,"tp_prob_under":0.4957,"FT_home_points":65.0,"FT_away_points":71.0,"FT_total_points":136.0},{"match_id":1842644.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Los Angeles Lakers","away_team":"New York Knicks","player_pair":"Donovan_IceKimi","mw_prob_home":0.952,"mw_prob_away":0.048,"inp_total_points":113.0,"tp_threshold":113.5,"tp_prob_over":0.4822,"tp_prob_under":0.5178,"FT_home_points":71.0,"FT_away_points":48.0,"FT_total_points":119.0},{"match_id":1842645.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Los Angeles Lakers","away_team":"New York Knicks","player_pair":"IceKimi_Luka","mw_prob_home":0.8448,"mw_prob_away":0.1552,"inp_total_points":131.94,"tp_threshold":131.5,"tp_prob_over":0.5118,"tp_prob_under":0.4882,"FT_home_points":61.0,"FT_away_points":64.0,"FT_total_points":125.0},{"match_id":1842646.0,"home_player":"Donovan","away_player":"Luka","home_team":"Atlanta Hawks","away_team":"Detroit Pistons","player_pair":"Donovan_Luka","mw_prob_home":0.1614,"mw_prob_away":0.8386,"inp_total_points":115.9,"tp_threshold":115.5,"tp_prob_over":0.5103,"tp_prob_under":0.4897,"FT_home_points":55.0,"FT_away_points":73.0,"FT_total_points":128.0},{"match_id":1842647.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Atlanta Hawks","away_team":"Detroit Pistons","player_pair":"Donovan_IceKimi","mw_prob_home":0.9522,"mw_prob_away":0.0478,"inp_total_points":114.5,"tp_threshold":114.5,"tp_prob_over":0.494,"tp_prob_under":0.506,"FT_home_points":81.0,"FT_away_points":42.0,"FT_total_points":123.0},{"match_id":1842648.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Cleveland Cavaliers","away_team":"Utah Jazz","player_pair":"IceKimi_Luka","mw_prob_home":0.8161,"mw_prob_away":0.1839,"inp_total_points":130.63,"tp_threshold":130.5,"tp_prob_over":0.5024,"tp_prob_under":0.4976,"FT_home_points":69.0,"FT_away_points":57.0,"FT_total_points":126.0}]')
    if llm_request.contents[-1].parts[0].text is not None:
        llm_request.contents[-1].parts.append(example_table)
        print(f"[Callback] Added data table for agent: {agent_name}")
    return None


def table_selector(table_name: str) -> dict:
    """Retrieves a sample table which will be used for the query.

    Args:
        table_name (str): Name of the table to retrieve data from.

    Returns:
        dict: status and result or error msg.
    """
    if "result" in table_name.lower():
        return {
            "status": "success",
            "table": [{"match_id":1842639.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Brooklyn Nets","away_team":"Golden State Warriors","player_pair":"IceKimi_Luka","mw_prob_home":0.8422,"mw_prob_away":0.1578,"inp_total_points":131.94,"tp_threshold":131.5,"tp_prob_over":0.5074,"tp_prob_under":0.4925,"FT_home_points":77.0,"FT_away_points":69.0,"FT_total_points":146.0},{"match_id":1842640.0,"home_player":"Donovan","away_player":"Luka","home_team":"Boston Celtics","away_team":"Philadelphia 76ers","player_pair":"Donovan_Luka","mw_prob_home":0.166,"mw_prob_away":0.834,"inp_total_points":113.8,"tp_threshold":113.5,"tp_prob_over":0.5043,"tp_prob_under":0.4957,"FT_home_points":53.0,"FT_away_points":62.0,"FT_total_points":115.0},{"match_id":1842641.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Boston Celtics","away_team":"Philadelphia 76ers","player_pair":"Donovan_IceKimi","mw_prob_home":0.9517,"mw_prob_away":0.0483,"inp_total_points":115.5,"tp_threshold":115.5,"tp_prob_over":0.4938,"tp_prob_under":0.5062,"FT_home_points":59.0,"FT_away_points":49.0,"FT_total_points":108.0},{"match_id":1842642.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Toronto Raptors","away_team":"Washington Wizards","player_pair":"IceKimi_Luka","mw_prob_home":0.8422,"mw_prob_away":0.1578,"inp_total_points":133.13,"tp_threshold":133.5,"tp_prob_over":0.4914,"tp_prob_under":0.5086,"FT_home_points":64.0,"FT_away_points":61.0,"FT_total_points":125.0},{"match_id":1842643.0,"home_player":"Donovan","away_player":"Luka","home_team":"Toronto Raptors","away_team":"Washington Wizards","player_pair":"Donovan_Luka","mw_prob_home":0.1629,"mw_prob_away":0.8371,"inp_total_points":113.8,"tp_threshold":113.5,"tp_prob_over":0.5043,"tp_prob_under":0.4957,"FT_home_points":65.0,"FT_away_points":71.0,"FT_total_points":136.0},{"match_id":1842644.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Los Angeles Lakers","away_team":"New York Knicks","player_pair":"Donovan_IceKimi","mw_prob_home":0.952,"mw_prob_away":0.048,"inp_total_points":113.0,"tp_threshold":113.5,"tp_prob_over":0.4822,"tp_prob_under":0.5178,"FT_home_points":71.0,"FT_away_points":48.0,"FT_total_points":119.0},{"match_id":1842645.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Los Angeles Lakers","away_team":"New York Knicks","player_pair":"IceKimi_Luka","mw_prob_home":0.8448,"mw_prob_away":0.1552,"inp_total_points":131.94,"tp_threshold":131.5,"tp_prob_over":0.5118,"tp_prob_under":0.4882,"FT_home_points":61.0,"FT_away_points":64.0,"FT_total_points":125.0},{"match_id":1842646.0,"home_player":"Donovan","away_player":"Luka","home_team":"Atlanta Hawks","away_team":"Detroit Pistons","player_pair":"Donovan_Luka","mw_prob_home":0.1614,"mw_prob_away":0.8386,"inp_total_points":115.9,"tp_threshold":115.5,"tp_prob_over":0.5103,"tp_prob_under":0.4897,"FT_home_points":55.0,"FT_away_points":73.0,"FT_total_points":128.0},{"match_id":1842647.0,"home_player":"IceKimi","away_player":"Donovan","home_team":"Atlanta Hawks","away_team":"Detroit Pistons","player_pair":"Donovan_IceKimi","mw_prob_home":0.9522,"mw_prob_away":0.0478,"inp_total_points":114.5,"tp_threshold":114.5,"tp_prob_over":0.494,"tp_prob_under":0.506,"FT_home_points":81.0,"FT_away_points":42.0,"FT_total_points":123.0},{"match_id":1842648.0,"home_player":"IceKimi","away_player":"Luka","home_team":"Cleveland Cavaliers","away_team":"Utah Jazz","player_pair":"IceKimi_Luka","mw_prob_home":0.8161,"mw_prob_away":0.1839,"inp_total_points":130.63,"tp_threshold":130.5,"tp_prob_over":0.5024,"tp_prob_under":0.4976,"FT_home_points":69.0,"FT_away_points":57.0,"FT_total_points":126.0}],
        }
    elif "live" in table_name.lower():
        return {
            "status": "success",
            "table": [{"match_id":1835187,"map_id":2030506,"timestamp":1749554232,"points_light":0,"points_dark":0,"quarter":1,"team":None,"map_time":0.0,"ball_possession":None,"mw_prob_home":0.757,"mw_prob_away":0.243,"tp_threshold":130.5,"tp_prob_over":0.48,"tp_prob_under":0.52},{"match_id":1835187,"map_id":2030506,"timestamp":1749554434,"points_light":0,"points_dark":0,"quarter":1,"team":None,"map_time":22.0,"ball_possession":"DARK","mw_prob_home":0.775,"mw_prob_away":0.225,"tp_threshold":129.5,"tp_prob_over":0.481,"tp_prob_under":0.519},{"match_id":1835187,"map_id":2030506,"timestamp":1749554459,"points_light":2,"points_dark":0,"quarter":1,"team":"LIGHT","map_time":46.0,"ball_possession":"DARK","mw_prob_home":0.775,"mw_prob_away":0.225,"tp_threshold":129.5,"tp_prob_over":0.481,"tp_prob_under":0.519},{"match_id":1835187,"map_id":2030506,"timestamp":1749554474,"points_light":2,"points_dark":0,"quarter":1,"team":"LIGHT","map_time":62.0,"ball_possession":"LIGHT","mw_prob_home":0.775,"mw_prob_away":0.225,"tp_threshold":129.5,"tp_prob_over":0.481,"tp_prob_under":0.519},{"match_id":1835187,"map_id":2030506,"timestamp":1749554488,"points_light":2,"points_dark":3,"quarter":1,"team":"DARK","map_time":76.0,"ball_possession":"DARK","mw_prob_home":0.74,"mw_prob_away":0.26,"tp_threshold":129.5,"tp_prob_over":0.481,"tp_prob_under":0.519},{"match_id":1835187,"map_id":2030506,"timestamp":1749554489,"points_light":5,"points_dark":3,"quarter":1,"team":"LIGHT","map_time":77.0,"ball_possession":"DARK","mw_prob_home":0.74,"mw_prob_away":0.26,"tp_threshold":129.5,"tp_prob_over":0.481,"tp_prob_under":0.519},{"match_id":1835187,"map_id":2030506,"timestamp":1749554490,"points_light":5,"points_dark":3,"quarter":1,"team":None,"map_time":None,"ball_possession":"DARK","mw_prob_home":0.74,"mw_prob_away":0.26,"tp_threshold":129.5,"tp_prob_over":0.492,"tp_prob_under":0.508},{"match_id":1835188,"map_id":2030567,"timestamp":1749552562,"points_light":0,"points_dark":0,"quarter":1,"team":None,"map_time":0.0,"ball_possession":None,"mw_prob_home":0.584,"mw_prob_away":0.416,"tp_threshold":115.5,"tp_prob_over":0.481,"tp_prob_under":0.519},{"match_id":1835188,"map_id":2030567,"timestamp":1749556339,"points_light":0,"points_dark":0,"quarter":1,"team":None,"map_time":8.0,"ball_possession":"DARK","mw_prob_home":0.609,"mw_prob_away":0.391,"tp_threshold":114.5,"tp_prob_over":0.487,"tp_prob_under":0.513},{"match_id":1835188,"map_id":2030567,"timestamp":1749556351,"points_light":2,"points_dark":0,"quarter":1,"team":"LIGHT","map_time":20.0,"ball_possession":"LIGHT","mw_prob_home":0.609,"mw_prob_away":0.391,"tp_threshold":115.5,"tp_prob_over":0.503,"tp_prob_under":0.497},{"match_id":1835188,"map_id":2030567,"timestamp":1749556353,"points_light":2,"points_dark":3,"quarter":1,"team":"DARK","map_time":21.0,"ball_possession":"LIGHT","mw_prob_home":0.579,"mw_prob_away":0.421,"tp_threshold":115.5,"tp_prob_over":0.503,"tp_prob_under":0.497}],
        }
    else:
        return {
            "status": "error",
            "error_message": f"Unrecognized table name '{table_name}'.",
        }


root_agent = Agent(
    name="test_case_generation_agent",
    model=ROOT_AGENT_MODEL,
    description=(
        "Agent that processes data from a given table into a new column based on a query given in natural language."
    ),
    instruction=instructions,
    before_model_callback=table_adder,
    #tools=[table_selector],  # A hard-coded table is now used, but it can support a query-based source selection too.
)
